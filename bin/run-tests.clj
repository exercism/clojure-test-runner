#!/usr/bin/env bb

(require '[clojure.java.io :as io]
         '[clojure.java.shell :as shell]
         '[clojure.string :as str])

; Synopsis:
; Test the test runner by running it against a predefined set of solutions 
; with an expected output.

; Output:
; Outputs the diff of the expected test results against the actual test results
; generated by the test runner.

; Example:
; ./bin/run-tests.clj

(defn slug [dir]
  (str/replace (.getName (first (.listFiles (io/file (str (.getPath dir) "/src"))))) ".clj" ""))

(def diffs (atom 0))

; Iterate over all test directories
(doseq [^java.io.File dir (->> (io/file "tests/") (.listFiles))]
  (let [name (.getName dir)
        slug (slug dir)
        path (.getPath dir)
        target (str path "/target")
        results (str path "/results.json")
        expected (str path "/expected_results.json")
        diff (shell/sh "diff" results expected)]
    (shell/sh "rm" "-rf" target)
    (shell/sh "bin/run.sh" slug path path)
    (prn (str name ": comparing results.json to expected_results.json"))
    (prn (:out diff))
    (when (= 1 (:exit diff))
      (swap! diffs inc))))

(println (str "\n" @diffs " diffs"))
(System/exit @diffs)
